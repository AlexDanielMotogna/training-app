generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ========================================
// PLATFORM - SPORTS CATALOG (Global)
// ========================================

model Sport {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  name              String   // "American Football"
  slug              String   @unique // "american-football"
  icon              String?  // Material UI icon name
  isActive          Boolean  @default(true)
  displayOrder      Int      @default(0)

  // Translations
  nameTranslations  Json     @default("{}") // { "es": "Fútbol Americano", "de": "American Football" }

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  positions         Position[]
  ageCategories     AgeCategory[]
  metrics           SportMetric[]
  organizations     Organization[]
}

model Position {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  sportId           String   @db.ObjectId
  name              String   // "Quarterback"
  abbreviation      String   // "QB"
  group             String?  // "Offense", "Defense"
  displayOrder      Int      @default(0)

  nameTranslations  Json     @default("{}")
  groupTranslations Json     @default("{}")

  sport             Sport    @relation(fields: [sportId], references: [id], onDelete: Cascade)

  @@unique([sportId, abbreviation])
  @@index([sportId])
}

model AgeCategory {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  sportId           String   @db.ObjectId
  name              String   // "Under 15"
  code              String   // "U15"
  minAge            Int?
  maxAge            Int?
  displayOrder      Int      @default(0)

  nameTranslations  Json     @default("{}")

  sport             Sport    @relation(fields: [sportId], references: [id], onDelete: Cascade)
  teams             Team[]

  @@unique([sportId, code])
  @@index([sportId])
}

model SportMetric {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  sportId           String   @db.ObjectId
  name              String   // "40 Yard Dash"
  unit              String   // "seconds", "inches", "reps"
  type              String   // "time", "distance", "weight", "reps", "score"
  isLowerBetter     Boolean  @default(false) // For time-based metrics
  displayOrder      Int      @default(0)

  nameTranslations  Json     @default("{}")

  sport             Sport    @relation(fields: [sportId], references: [id], onDelete: Cascade)

  @@unique([sportId, name])
  @@index([sportId])
}

// ========================================
// MULTI-TENANCY - ORGANIZATIONS
// ========================================

model Organization {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  name              String   // "Real Madrid CF"
  slug              String   @unique // "real-madrid-cf" (for URLs)
  sportId           String   @db.ObjectId

  // Subscription & Billing
  plan              String   @default("free") // free, starter, pro, enterprise
  stripeCustomerId  String?  // Will be unique when set, but allows multiple nulls
  subscriptionStatus String  @default("trialing") // trialing, active, past_due, canceled, incomplete
  trialEndsAt       DateTime?

  // Limits based on plan
  maxMembers        Int      @default(15)  // Free: 15, Starter: 50, Pro: 200, Enterprise: unlimited
  maxCoaches        Int      @default(2)   // Free: 2, Starter: 5, Pro: 20, Enterprise: unlimited
  maxTeams          Int      @default(1)   // Free: 1, Starter: 3, Pro: 10, Enterprise: unlimited
  maxStorageGB      Int      @default(1)   // Free: 1GB, Starter: 10GB, Pro: 50GB, Enterprise: 500GB

  // Branding
  logoUrl           String?
  logoPublicId      String?  // Cloudinary public_id
  faviconUrl        String?
  faviconPublicId   String?  // Cloudinary public_id
  primaryColor      String   @default("#1976d2")
  secondaryColor    String   @default("#dc004e")
  customDomain      String?  // Pro+: "training.realmadrid.com" (will be unique when set, but allows multiple nulls)

  // Settings
  timezone          String   @default("Europe/Madrid")
  language          String   @default("en") // Default language
  seasonPhase       String   @default("off-season") // off-season, pre-season, in-season, post-season
  allowedFeatures   Json     @default("[]") // Feature flags based on plan

  // AI Configuration (organization-wide)
  aiApiKey          String?

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String   @db.ObjectId

  // Relations
  sport             Sport    @relation(fields: [sportId], references: [id])
  teams             Team[]
  members           OrganizationMember[]
  invitations       Invitation[]
  subscription      Subscription?
  auditLogs         AuditLog[]

  // Content (organization-scoped)
  users             User[]
  trainingSessions  TrainingSession[]
  videos            Video[]
  videoTags         VideoTag[]
  exercises         Exercise[]
  exerciseCategories ExerciseCategory[]
  trainingTemplates TrainingTemplate[]
  trainingTypes     TrainingType[]
  blockInfos        BlockInfo[]
  drills            Drill[]
  drillCategories   DrillCategory[]
  drillSessions     DrillTrainingSession[]
  equipment         Equipment[]
  matches           Match[]
  pointsConfigs     PointsConfig[]
  notifications     Notification[]

  @@index([sportId])
}

model Team {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId    String   @db.ObjectId
  name              String   // "Seniors", "Under 15 A"
  ageCategoryId     String   @db.ObjectId

  // Settings
  isActive          Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ageCategory       AgeCategory  @relation(fields: [ageCategoryId], references: [id])
  members           TeamMember[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([ageCategoryId])
}

model OrganizationMember {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId    String   @db.ObjectId
  userId            String   @db.ObjectId
  role              String   // owner, admin, coach, player

  // Permissions (granular control)
  canManageMembers  Boolean  @default(false)
  canManageContent  Boolean  @default(false)
  canManageBilling  Boolean  @default(false)
  canManageSettings Boolean  @default(false)

  joinedAt          DateTime @default(now())
  invitedBy         String?  @db.ObjectId

  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([organizationId])
}

model TeamMember {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  teamId            String   @db.ObjectId
  userId            String   @db.ObjectId
  role              String   // head_coach, assistant_coach, player
  positionId        String?  @db.ObjectId // Reference to Position
  jerseyNumber      Int?

  joinedAt          DateTime @default(now())
  leftAt            DateTime?
  isActive          Boolean  @default(true)

  team              Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@index([teamId])
}

// ========================================
// SUBSCRIPTIONS & BILLING
// ========================================

model Subscription {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId        String   @unique @db.ObjectId

  // Stripe IDs
  stripeSubscriptionId  String   @unique
  stripePriceId         String
  stripeProductId       String

  // Status
  status                String   // active, past_due, canceled, incomplete, trialing

  // Billing cycle
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean  @default(false)
  canceledAt            DateTime?

  // Plan details
  plan                  String   // free, starter, pro, enterprise
  interval              String   // month, year
  amount                Int      // in cents
  currency              String   @default("eur")

  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices              Invoice[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Invoice {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  subscriptionId        String   @db.ObjectId
  stripeInvoiceId       String   @unique

  amount                Int      // in cents
  currency              String
  status                String   // paid, open, void, uncollectible
  invoiceUrl            String?
  invoicePdf            String?

  periodStart           DateTime
  periodEnd             DateTime
  paidAt                DateTime?

  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  createdAt             DateTime @default(now())
}

model Invitation {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId    String   @db.ObjectId
  email             String
  role              String   // admin, coach, player
  teamIds           String[] @db.ObjectId // Teams to join upon acceptance

  token             String   @unique
  expiresAt         DateTime
  acceptedAt        DateTime?

  invitedBy         String   @db.ObjectId

  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())

  @@unique([organizationId, email])
}

// ========================================
// AUDIT & ANALYTICS
// ========================================

model AuditLog {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId    String   @db.ObjectId
  userId            String?  @db.ObjectId

  action            String   // create, update, delete, login, invite, etc.
  resource          String   // user, team, template, workout, etc.
  resourceId        String?

  details           Json?    // Additional context
  ipAddress         String?
  userAgent         String?

  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([userId])
}

model UsageMetrics {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId    String   @db.ObjectId
  month             String   // "2025-01"

  // Counts
  activeMembers     Int      @default(0)
  workoutsLogged    Int      @default(0)
  trainingSessions  Int      @default(0)
  videosWatched     Int      @default(0)
  drillsCompleted   Int      @default(0)

  // Storage
  storageUsedBytes  BigInt   @default(0)

  // API
  apiCalls          Int      @default(0)

  updatedAt         DateTime @updatedAt

  @@unique([organizationId, month])
  @@index([organizationId])
}

// ========================================
// USERS & AUTHENTICATION
// ========================================

model User {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  email         String   @unique
  passwordHash  String
  name          String

  // Multi-tenancy: Primary organization (can be member of multiple orgs)
  organizationId String?  @db.ObjectId

  // Platform role (for super-admins who manage the SaaS)
  platformRole  String   @default("user") // user, support, admin, super_admin

  // Legacy role field - now managed via OrganizationMember.role
  role          String   @default("player") // 'player' | 'coach' (kept for backwards compatibility)

  // Player-specific fields (moved to TeamMember for multi-team support, kept here for profile)
  jerseyNumber  Int?
  birthDate     String?  // ISO date string
  age           Int?
  weightKg      Float?
  heightCm      Float?
  position      String?  // Legacy: now use TeamMember.positionId
  sex           String?  // 'male' | 'female'
  ageCategory   String?  // Legacy: now determined by Team.ageCategoryId

  // Coach-specific fields (legacy - now use TeamMember assignments)
  coachCategories String[] @default([])

  // Contact info
  phone         String?
  instagram     String?
  snapchat      String?
  tiktok        String?
  hudl          String?

  // Privacy settings
  metricsPublic Boolean  @default(true)

  // Preferences
  preferredLanguage String @default("de") // 'de' | 'en'

  // AI settings (user-specific override)
  aiCoachEnabled Boolean @default(false)
  aiApiKey       String?

  // Profile images
  avatarUrl      String?  // Cloudinary URL for profile picture
  avatarPublicId String?  // Cloudinary public_id for deletion

  // Password reset
  resetToken     String?
  resetTokenExpiry DateTime?

  // Email verification
  emailVerified    Boolean  @default(false)
  emailVerifiedAt  DateTime?

  // Activity tracking
  lastLoginAt      DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  organization      Organization? @relation(fields: [organizationId], references: [id])
  organizationMemberships OrganizationMember[]
  teamMemberships   TeamMember[]
  sessionCreated    TrainingSession[]
  attendanceVotes   AttendancePollVote[]
  workoutLogs       WorkoutLog[]
  userPlans         UserPlan[]
  workoutReports    WorkoutReport[]
  testResults       TestResult[]
  videoProgress     VideoProgress[]
  notifications     Notification[]
  playerWeeklyPoints PlayerWeeklyPoints[]

  @@index([organizationId])
}

// ========================================
// TRAINING SESSIONS (Online)
// ========================================

model TrainingSession {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  teamId          String?  @db.ObjectId  // Optional: specific team
  creatorId       String   @db.ObjectId
  creatorName     String

  sessionCategory String   // 'team' | 'private'
  type            String   // 'gym' | 'outdoor' | 'coach-plan' | 'free-training'
  title           String
  location        String
  address         String?
  date            String   // ISO date
  time            String   // HH:mm format
  description     String?

  attendees       Json     // Array of {userId, userName, status: RSVPStatus}

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator         User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  polls           AttendancePoll[]

  @@index([organizationId])
  @@index([organizationId, date])
  @@index([teamId])
}

// ========================================
// ATTENDANCE POLLS (Online)
// ========================================

model AttendancePoll {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionId   String   @db.ObjectId
  sessionName String
  sessionDate String
  createdBy   String
  createdAt   String
  expiresAt   String
  isActive    Boolean  @default(true)

  session     TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  votes       AttendancePollVote[]
}

model AttendancePollVote {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  pollId       String   @db.ObjectId
  userId       String   @db.ObjectId
  userName     String
  userPosition String?  // User's position (QB, RB, WR, etc.)
  option       String   // 'training' | 'present' | 'absent'
  timestamp    String

  poll      AttendancePoll @relation(fields: [pollId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pollId, userId]) // One vote per user per poll
}

// ========================================
// VIDEOS (Online)
// ========================================

model Video {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  title           String
  description     String   @default("")
  youtubeUrl      String
  type            String   // 'position' | 'route' | 'coverage' | 'run'
  status          String   @default("draft") // 'draft' | 'published'
  level           String?  // 'intro' | 'intermediate' | 'advanced'
  unit            String?  // 'Offense' | 'Defense' | 'Special Teams'

  // Tags based on type
  positions   String[] @default([])
  routes      String[] @default([])
  coverages   String[] @default([])
  runs        String[] @default([])

  // Metadata
  createdBy   String   @db.ObjectId
  order       Int      @default(0)
  isPinned    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([createdBy])
}

// ========================================
// VIDEO PROGRESS (Track player progress)
// ========================================

model VideoProgress {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  videoId       String   @db.ObjectId
  lastTimestamp Int      // Last watched position in seconds
  totalDuration Int      // Total video duration in seconds
  percentWatched Int     // 0-100
  completed     Boolean  @default(false)
  lastWatchedAt DateTime @updatedAt

  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}

// ========================================
// VIDEO TAGS (Dynamic tags for positions, routes, coverages)
// ========================================

model VideoTag {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  type            String   // 'position' | 'route' | 'coverage' | 'run'
  name            String   // 'QB', 'Slant', 'Cover 2', 'Inside Zone'
  order           Int      @default(0) // For custom ordering
  isDefault       Boolean  @default(false) // System defaults vs coach custom
  createdBy       String?  @db.ObjectId
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, type, name])
  @@index([organizationId, type, order])
}

// ========================================
// TEAM SETTINGS (DEPRECATED - Now in Organization model)
// Keeping for backwards compatibility during migration
// ========================================

model TeamSettings {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  teamName       String
  appName        String?
  primaryColor   String
  secondaryColor String
  logoUrl        String?
  faviconUrl     String?

  // Season and team configuration
  seasonPhase    String   @default("off-season") // 'off-season' | 'pre-season' | 'in-season'
  teamLevel      String   @default("amateur") // 'amateur' | 'semi-pro' | 'pro' | 'youth' | 'recreational'
  teamCategory   String   @default("principal") // 'juvenil' | 'principal' | 'reserves' | 'academy'

  // Age categories configuration (SaaS-ready: each team defines their own)
  allowedCategories Json @default("[]") // Array of category strings

  // Optional AI API key for team-wide AI features
  aiApiKey       String?

  updatedBy      String?  @db.ObjectId // Coach who last updated
  updatedAt      DateTime @updatedAt

  // NOTE: This model is deprecated. New apps should use Organization model instead.
  // Will be removed in future migration after data is moved to Organization.
}

// ========================================
// POINTS SYSTEM CONFIGURATION (Online)
// ========================================

model PointsConfig {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  weeklyTarget    Int      @default(20)
  maxDailyPoints  Int?     @default(3)
  categories      Json     // Array of PointCategory objects
  colorScale      Json     // {low: string, medium: string, high: string}
  updatedBy       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// ========================================
// PLAYER WEEKLY POINTS (Leaderboard Data)
// ========================================

model PlayerWeeklyPoints {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  userId          String   @db.ObjectId
  teamId          String?  @db.ObjectId  // Optional: for team-specific leaderboards
  week            String   // ISO week format: "2025-W03"

  // Point totals
  totalPoints    Float    @default(0)
  targetPoints   Int      @default(20)

  // Activity tracking
  workoutDays    Int      @default(0)
  teamTrainingDays Int    @default(0)
  coachWorkoutDays Int    @default(0)
  personalWorkoutDays Int @default(0)

  // Detailed breakdown
  breakdown      Json     // Array of PointsBreakdown entries (per-workout details)

  lastUpdated    DateTime @default(now())
  createdAt      DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId, week])
  @@index([organizationId, week])
  @@index([organizationId, teamId, week])
  @@index([userId])
}

// ========================================
// EXERCISE CATALOG (Could be synced to offline)
// ========================================

model ExerciseCategory {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String?  @db.ObjectId  // NULL = global/system category
  key             String   // Unique key (e.g., "strength", "speed", "cod")
  nameEN          String   // English name
  nameDE          String   // German translation
  color           String   @default("#1976d2")  // Color for UI display
  icon            String?  // Optional icon name for UI
  active          Boolean  @default(true)  // Active/inactive flag
  isGlobal        Boolean  @default(false) // System-wide category
  createdBy       String?  @db.ObjectId  // Coach who created it (null for system categories)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, key])
  @@index([organizationId])
}

model Exercise {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String?  @db.ObjectId  // NULL = global/system exercise
  name            String
  category        String   // References ExerciseCategory.key (e.g., "strength", "speed")
  youtubeUrl      String?  // YouTube URL
  positionTags    String[] // ['RB', 'WR', 'LB', etc.] - empty array means all positions
  muscleGroups    String[] // ['legs', 'chest', 'back', 'shoulders', 'arms', 'core', 'full-body']
  isGlobal        Boolean  @default(false) // Global (platform-wide) exercises
  createdBy       String?  @db.ObjectId    // Coach who created it (null for system exercises)
  isCustom        Boolean  @default(false) // Custom exercise flag
  descriptionEN   String?
  descriptionDE   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, category])
}

// ========================================
// TRAINING TEMPLATES (Coach Plans)
// ========================================

model TrainingTemplate {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId   String   @db.ObjectId  // Tenant isolation
  teamId           String?  @db.ObjectId  // Optional: team-specific template
  name             String
  trainingType     String   // TrainingType ID
  position         String?  // Legacy: Single position (backwards compatibility)
  positions        String[] @default([]) // Multiple positions ['RB', 'WR', etc.]
  season           String   @default("off-season") // 'in-season' | 'off-season' | 'pre-season'
  durationWeeks    Int      @default(8)
  frequencyPerWeek String   @default("2-3")
  weeklyNotes      String?
  blocks           Json     // Array of TemplateBlock
  isActive         Boolean  @default(true)
  createdBy        String   @db.ObjectId

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignments      TrainingAssignment[]

  @@index([organizationId])
  @@index([organizationId, trainingType])
  @@index([teamId])
}

// ========================================
// TRAINING ASSIGNMENTS (Coach → Player)
// ========================================

model TrainingAssignment {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  templateId  String   @db.ObjectId
  playerIds   String[] @db.ObjectId  // Multiple players can be assigned
  assignedBy  String   @db.ObjectId  // Coach ID
  startDate   String   // ISO date
  endDate     String?  // ISO date - null means ongoing
  active      Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  template    TrainingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

// ========================================
// WORKOUT LOGS (Player Training Logs)
// ========================================

model WorkoutLog {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId       String   @db.ObjectId  // Tenant isolation
  teamId               String?  @db.ObjectId  // Optional: team context
  userId               String   @db.ObjectId
  userName             String?
  date                 String   // ISO date when workout was completed
  entries              Json     // Array of WorkoutEntry with setData
  notes                String?
  source               String   // 'coach' | 'player'
  planTemplateId       String?  // Reference to template/plan used
  planName             String?  // Name of the plan/block
  duration             Int?     // Duration in minutes
  planMetadata         Json?    // {totalExercises, totalTargetSets}
  completionPercentage Int?     // 0-100 completion percentage

  // Points system
  points               Float?   // Calculated points for this workout
  pointsCategory       String?  // 'light' | 'moderate' | 'team' | 'intensive'

  createdAt            String   // ISO datetime when log was created
  syncedAt             DateTime @default(now()) // When synced to backend

  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, userId, date])
  @@index([organizationId, date])
  @@index([teamId])
}

// ========================================
// USER PLANS (Player-Created Workout Plans)
// ========================================

model UserPlan {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  userId          String   @db.ObjectId
  name            String
  trainingType    String   // 'strength_conditioning' | 'sprints_speed' | etc.
  exercises       Json     // Array of PlanExercise objects
  notes           String?
  timesCompleted  Int      @default(0)

  createdAt       String   // ISO datetime
  updatedAt       String   // ISO datetime
  syncedAt        DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, userId, createdAt])
}

// ========================================
// WORKOUT REPORTS (AI-Generated Analysis)
// ========================================

model WorkoutReport {
  id                      String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId          String   @db.ObjectId  // Tenant isolation
  userId                  String   @db.ObjectId
  workoutTitle            String?  @default("")
  date                    String?  @default("")  // ISO date string (YYYY-MM-DD)
  duration                Int?     @default(0)   // Duration in minutes
  source                  String?  @default("player")  // 'coach' | 'player'

  // Performance Scores (0-100)
  intensityScore          Int?     @default(50)
  workCapacityScore       Int?     @default(50)
  athleticQualityScore    Int?     @default(50)
  positionRelevanceScore  Int?     @default(50)

  // Breakdown
  totalVolume             Int?     @default(0)    // kg
  totalDistance           Float?                  // km (for cardio workouts)
  avgRPE                  Float?   @default(5)    // 1-10
  setsCompleted           Int?     @default(0)
  setsPlanned             Int?     @default(0)

  // Athletic focus (percentages)
  powerWork               Int?     @default(0)
  strengthWork            Int?     @default(0)
  speedWork               Int?     @default(0)

  // Highlights (auto-generated)
  strengths               Json?    @default("[]")  // Array of strings
  warnings                Json?    @default("[]")  // Array of strings

  // Progress comparison
  volumeChange            Int?                     // % vs last week
  intensityChange         Int?                     // % vs last week

  // Recovery & Validation
  recoveryDemand          String?  @default("medium")  // 'low' | 'medium' | 'high' | 'very-high' | 'insufficient'
  recommendedRestHours    Int?     @default(24)
  sessionValid            Boolean? @default(true)

  // AI Insights
  coachInsights           String?  @default("")
  keyInsights             Json?    @default("[]")  // Array of strings (legacy)
  recommendations         Json?    @default("[]")  // Array of strings (legacy)
  personalObservations    String?  // Player's notes

  // Metadata
  aiGenerated             Boolean? @default(false)
  workoutEntries          Json?    @default("[]")  // Complete workout data for reference

  createdAt               String?  @default("")  // ISO datetime
  syncedAt                DateTime @default(now())

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, userId, createdAt])
}

// ========================================
// TRAINING TYPES (Training Categories)
// ========================================

model TrainingType {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String?  @db.ObjectId  // NULL = global/system type
  key             String   // 'strength_conditioning' | 'sprints_speed' | 'cb_drills'
  nameEN          String
  nameDE          String
  season          String   // 'in-season' | 'off-season' | 'pre-season' | 'all'
  active          Boolean  @default(true)
  isGlobal        Boolean  @default(false) // System-wide type

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, key])
  @@index([organizationId])
}

// ========================================
// BLOCK INFO (Exercise Block Descriptions)
// ========================================

model BlockInfo {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  blockName       String
  trainingType    String   // 'strength_conditioning' | 'sprints_speed'
  infoText_en     String
  infoText_de     String

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, blockName, trainingType])
  @@index([organizationId])
}

// ========================================
// NOTIFICATIONS (In-App)
// ========================================

model Notification {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  userId          String   @db.ObjectId  // Recipient
  type            String   // 'new_plan' | 'plan_updated' | 'new_session' | 'private_session' | 'attendance_poll'
  title           String
  message         String
  read            Boolean  @default(false)
  actionUrl       String?  // Optional URL to navigate to

  // Optional metadata
  referenceId     String?  // ID of related entity (template, session, poll, etc.)

  createdAt       DateTime @default(now())

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, userId, read, createdAt])
  @@index([userId])
}

// ========================================
// TEST RESULTS (Strength, Speed, Power, Agility)
// ========================================

model TestResult {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  userId          String   @db.ObjectId

  // Test type: 'strength' | 'speed' | 'power' | 'agility'
  testType        String

  // Test date
  dateISO         String   // ISO date string (YYYY-MM-DD)

  // Test data stored as JSON (different structure per test type)
  // For strength: { byTest: [], bySegment: {}, strengthIndex: number, label: string, tier: string }
  // For speed: { byTest: [], speedScore: number, label: string, tier: string }
  // For power: { byTest: [], powerScore: number, label: string, tier: string }
  // For agility: { byTest: [], agilityScore: number, label: string, tier: string }
  testData        Json

  // Overall score (0-100) for quick filtering/sorting
  score           Int

  // Tier: 'ELITE' | 'ADVANCED' | 'INTERMEDIATE' | 'BEGINNER'
  tier            String

  // Whether this is the current/latest test for this user+type
  isCurrent       Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, userId, testType, isCurrent])
  @@index([organizationId, userId, dateISO])
  @@index([organizationId])
}

// ========================================
// DRILLS (Training drills library)
// ========================================

model Drill {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  name            String
  category        String   // References DrillCategory.key (e.g., "athletik", "fundamentals")
  description     String
  coachingPoints  String

  // Personnel requirements
  players         Int      @default(0)  // Number of players needed
  coaches         Int      @default(0)  // Number of coaches needed
  dummies         Int      @default(0)  // Number of dummies needed

  // Equipment needed (stored as JSON array)
  // [{equipmentId: string, quantity: number}]
  equipment       Json     @default("[]")

  // Resources
  sketchUrl       String?  // Cloudinary URL for drill diagram/sketch
  sketchPublicId  String?  // Cloudinary public_id for deletion
  videoUrl        String?  // YouTube video URL
  imageUrl        String?  // Cloudinary URL for drill thumbnail image
  imagePublicId   String?  // Cloudinary public_id for image deletion

  // Organization
  difficulty      String   // 'basic' | 'advanced' | 'complex'
  trainingContext String?  // 'Warm-up' | 'Individual' | 'Team Period' | etc.

  // Metadata
  createdBy       String   @db.ObjectId
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, category, difficulty])
  @@index([createdBy])
}

// ========================================
// EQUIPMENT (Equipment catalog)
// ========================================

model Equipment {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  name            String
  quantity        Int?     // Total quantity available (optional)

  // Image
  imageUrl        String?  // Cloudinary URL for equipment photo
  imagePublicId   String?  // Cloudinary public_id for deletion

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
}

// ========================================
// DRILL CATEGORIES (Manageable categories)
// ========================================

model DrillCategory {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  key             String   // Unique key (e.g., "athletik", "fundamentals", "offense")
  name            String   // Category name (e.g., "Offense", "Defense", "Team")
  nameDE          String?  // German translation
  color           String   @default("#1976d2")  // Color for UI display
  createdBy       String   @db.ObjectId
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, key])
  @@index([organizationId])
}

// ========================================
// DRILL TRAINING SESSIONS
// ========================================

model DrillTrainingSession {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  teamId          String?  @db.ObjectId  // Optional: team-specific session
  name            String   // Session name (e.g., "Week 3 - Offense Drills")
  date            String   // Date of the session (YYYY-MM-DD format)
  drills          String[] // Array of drill IDs
  notes           String?  // Optional notes for the session
  createdBy       String   @db.ObjectId
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, date])
  @@index([teamId])
  @@index([createdBy])
}

// Match/Game model for Spielplan (Season Schedule)
model Match {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String   @db.ObjectId  // Tenant isolation
  teamId          String?  @db.ObjectId  // Optional: specific team's match
  spielnummer     String   // Game number (e.g., "25201")
  homeTeam        String   // Home team name
  awayTeam        String   // Away team name
  date            String   // Date of match (YYYY-MM-DD format)
  kickoff         String   // Kickoff time (HH:mm format)
  spielort        String   // Location/Stadium
  week            Int      // Week number (1-8)
  weekLabel       String   // Week label (e.g., "Woche 1 - 29./30.März")
  conference      String   // Conference (A, B, C, D)
  homeScore       Int?     // Home team score (null if not played yet)
  awayScore       Int?     // Away team score (null if not played yet)
  isRelegation    Boolean  @default(false) // Relegation game
  isSemifinal     Boolean  @default(false) // Semifinal
  isIronBowl      Boolean  @default(false) // Iron Bowl (Championship)
  createdBy       String   @db.ObjectId
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, spielnummer])
  @@index([organizationId])
  @@index([organizationId, date])
  @@index([organizationId, week])
  @@index([teamId])
}
